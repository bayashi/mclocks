name: E2E Tests

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/e2e.yaml"
      - "test/**"
      - "src/**"
      - "src-tauri/**"
      - "package.json"
      - "wdio.conf.js"

jobs:
  test:
    name: E2E Test
    runs-on: ${{ matrix.platform }}
    permissions:
      contents: read
      pull-requests: read
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            xvfb

      - name: Install Windows dependencies
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          winget install --id=Microsoft.EdgeWebView2Runtime -e --accept-package-agreements --accept-source-agreements || Write-Host "WebView2 may already be installed or installation failed"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            src-tauri/target
            ~/.cargo
          key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install

      - name: Start Tauri app and run E2E tests (Linux)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          XVFB_PID=$!
          pnpm tauri dev > /dev/null 2>&1 &
          TAURI_PID=$!
          echo "Waiting for app to start..."
          for i in {1..30}; do
            if curl -s http://localhost:1420 > /dev/null 2>&1; then
              echo "App is ready"
              break
            fi
            sleep 1
          done
          EXIT_CODE=0
          pnpm test || EXIT_CODE=$?
          kill $TAURI_PID 2>/dev/null || true
          kill $XVFB_PID 2>/dev/null || true
          pkill -f "tauri dev" || true
          pkill -f Xvfb || true
          exit $EXIT_CODE

      - name: Start Tauri app and run E2E tests (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $projectRoot = $PWD.Path
          $job = Start-Job -ScriptBlock { Set-Location $using:projectRoot; pnpm tauri dev }
          Write-Host "Waiting for app to start..."
          $appReady = $false
          for ($i = 0; $i -lt 30; $i++) {
            try {
              $null = Invoke-WebRequest -Uri "http://localhost:1420" -TimeoutSec 1 -ErrorAction Stop
              Write-Host "App is ready"
              $appReady = $true
              break
            } catch {
              Start-Sleep -Seconds 1
            }
          }
          if (-not $appReady) {
            Write-Host "Warning: App may not have started in time"
          }
          $exitCode = 0
          try {
            pnpm test
            $exitCode = $LASTEXITCODE
          } finally {
            Stop-Job -Job $job -ErrorAction SilentlyContinue
            Remove-Job -Job $job -Force -ErrorAction SilentlyContinue
            Get-Process -Name node,tauri -ErrorAction SilentlyContinue | Where-Object {$_.MainWindowTitle -eq ""} | Stop-Process -Force -ErrorAction SilentlyContinue
          }
          exit $exitCode
